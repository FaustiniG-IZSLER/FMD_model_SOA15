names(storico_final)
table(storico_final$orientamento_produttivo.tr3, storico_final$tipologia_produttiva, useNA="always")
#CHECK CLASSIFICAZIONE
table(storico_final$orientamento_produttivo.tr3, storico_final$tipologia_allevamento)
#la classificazione è avvenuta correttamente
#Classificazione dei misti in base alla tipologia produttiva----
# Definiamo i valori di tipologia produttiva che indicano produzione carne
levels(storico_final$tipologia_produttiva)
carne_values <- c("INGRASSO", "INGRASSO PER AUTOCONSUMO", "LINEA VACCA VITELLO", "VITELLI A CARNE BIANCA")
#classifichiamo i misti che in realtà fanno carne come Produzione carne e gli altri come latte/misto
table(storico_final$tipologia_produttiva, storico_final$tipologia_allevamento) #se guardi i Latte/misto ci sono alcuni che fanno anche carne
#vediamolo in grafico
# Crea il grafico a istogrammi con facet verticale per tipologia allevamento allevamento
agg_tipol <- storico_final[, .(num_aziende = uniqueN(codazienda_cf)),
by = .(tipologia_allevamento, tipologia_produttiva)]
dettaglio_tipologia_produttiva <- ggplot(agg_tipol, aes(x = tipologia_produttiva, y = num_aziende, fill = tipologia_produttiva)) +
geom_col() +
geom_text(aes(label = num_aziende), vjust = -0.5) +
facet_grid(rows = vars(tipologia_allevamento), scales = "free_x") +  # facet verticale
labs(title = "Numero di aziende per tipologia produttiva",
x = "Tipologia produttiva",
y = "Numero di aziende (uniche)") +
theme_minimal() +
theme(axis.text.x = element_text(angle = 45, hjust = 1),
legend.position = "none")  # rimuove la legenda
dettaglio_tipologia_produttiva
# Convertiamo la tipologia_allevamento in carattere (altrimenti dà dei numeri al posto dei nomi delle classi)
storico_final$tipologia_allevamento <- as.character(storico_final$tipologia_allevamento)
storico_final$orientamento_produttivo.tr3 <- as.character(storico_final$orientamento_produttivo.tr3)
table(storico_final$tipologia_produttiva, storico_final$orientamento_produttivo.tr3)
storico_final$tipologia_allevamento <- ifelse(
storico_final$orientamento_produttivo.tr3 == "MISTO" & storico_final$tipologia_produttiva %in% carne_values,
"Produzione carne",
ifelse(storico_final$orientamento_produttivo.tr3 == "MISTO", "Latte/Misto", storico_final$tipologia_allevamento)
)
table(storico_final$tipologia_produttiva, storico_final$tipologia_allevamento) #i numeri tornano
storico_final <- readRDS(file.path(output_dir, "storico_bovini_aperti2010_2025_Lombardia.rds"))
names(storico_final)
table(storico_final$orientamento_produttivo.tr3, storico_final$tipologia_produttiva, useNA="always")
#CHECK CLASSIFICAZIONE
table(storico_final$orientamento_produttivo.tr3, storico_final$tipologia_allevamento)
#la classificazione è avvenuta correttamente
#Classificazione dei misti in base alla tipologia produttiva----
# Definiamo i valori di tipologia produttiva che indicano produzione carne
levels(storico_final$tipologia_produttiva)
carne_values <- c("INGRASSO", "INGRASSO PER AUTOCONSUMO", "LINEA VACCA VITELLO", "VITELLI A CARNE BIANCA")
#classifichiamo i misti che in realtà fanno carne come Produzione carne e gli altri come latte/misto
table(storico_final$tipologia_produttiva, storico_final$tipologia_allevamento) #se guardi i Latte/misto ci sono alcuni che fanno anche carne
#vediamolo in grafico
# Crea il grafico a istogrammi con facet verticale per tipologia allevamento allevamento
agg_tipol <- storico_final[, .(num_aziende = uniqueN(codazienda_cf)),
by = .(tipologia_allevamento, tipologia_produttiva)]
dettaglio_tipologia_produttiva <- ggplot(agg_tipol, aes(x = tipologia_produttiva, y = num_aziende, fill = tipologia_produttiva)) +
geom_col() +
geom_text(aes(label = num_aziende), vjust = -0.5) +
facet_grid(rows = vars(tipologia_allevamento), scales = "free_x") +  # facet verticale
labs(title = "Numero di aziende per tipologia produttiva",
x = "Tipologia produttiva",
y = "Numero di aziende (uniche)") +
theme_minimal() +
theme(axis.text.x = element_text(angle = 45, hjust = 1),
legend.position = "none")  # rimuove la legenda
dettaglio_tipologia_produttiva
# Convertiamo la tipologia_allevamento in carattere (altrimenti dà dei numeri al posto dei nomi delle classi)
level(storico_final$orientamento_produttivo.tr3)
# Convertiamo la tipologia_allevamento in carattere (altrimenti dà dei numeri al posto dei nomi delle classi)
levels(storico_final$orientamento_produttivo.tr3)
levels(storico_final$tipologia_allevamento)
storico_final$tipologia_allevamento <- as.character(storico_final$tipologia_allevamento)
storico_final$orientamento_produttivo.tr3 <- as.character(storico_final$orientamento_produttivo.tr3)
table(storico_final$tipologia_produttiva, storico_final$orientamento_produttivo.tr3)
storico_final$tipologia_allevamento <- ifelse(
storico_final$orientamento_produttivo.tr3 == "Misto" & storico_final$tipologia_produttiva %in% carne_values,
"Produzione carne",
ifelse(storico_final$orientamento_produttivo.tr3 == "Misto", "Latte/Misto", storico_final$tipologia_allevamento)
)
table(storico_final$tipologia_produttiva, storico_final$tipologia_allevamento) #i numeri tornano
agg_tipol_new <- storico_final[, .(num_aziende = uniqueN(codazienda_cf)),
by = .(tipologia_allevamento, tipologia_produttiva)]
dettaglio_tipologia_produttiva_new <- ggplot(agg_tipol_new, aes(x = tipologia_produttiva, y = num_aziende, fill = tipologia_produttiva)) +
geom_col() +
geom_text(aes(label = num_aziende), vjust = -0.5) +
facet_grid(rows = vars(tipologia_allevamento), scales = "free_x") +  # facet verticale
labs(title = "Numero di aziende per tipologia produttiva",
x = "Tipologia produttiva",
y = "Numero di aziende (uniche)") +
theme_minimal() +
theme(axis.text.x = element_text(angle = 45, hjust = 1),
legend.position = "none")  # rimuove la legenda
dettaglio_tipologia_produttiva_new
#Rimuovi suffissi .tr3 e .tr4 e bdn----
setnames(storico_final, gsub("\\.tr4$|\\.tr3$|\\.bdn$", "", names(storico_final)))
names(storico_final)
duplicated_cols <- names(storico_final)[duplicated(names(storico_final))]
if (length(duplicated_cols) > 0) {
cat("Colonne duplicate trovate:\n")
print(duplicated_cols)
} else {
cat("Nessuna colonna duplicata trovata.\n")
}
for (col in date_cols) {
if (col %in% names(storico_final)) {
storico_final[[col]] <- as.Date(storico_final[[col]])
cat(paste("Colonna", col, "convertita in formato Date.\n"))
} else {
cat(paste("Colonna", col, "non trovata nel dataset.\n"))
}
}
date_cols <- c("data_riferimento", "data_elaborazione")
for (col in date_cols) {
if (col %in% names(storico_final)) {
storico_final[[col]] <- as.Date(storico_final[[col]])
cat(paste("Colonna", col, "convertita in formato Date.\n"))
} else {
cat(paste("Colonna", col, "non trovata nel dataset.\n"))
}
}
# 4. Conversione in factor
cols_to_factor <- c(
"orientamento_produttivo",
"tipologia_produttiva",
"classe_consistenza",
"flag_riproduzione",
"classe_allevamento",
"tipologia_allevamento",
"modalita_allevamento"
)
# Trasformazione in fattori
storico_final[, (cols_to_factor) := lapply(.SD, as.factor), .SDcols = cols_to_factor]
sapply(storico_final[, ..cols_to_factor], class)  # controlla le classi delle colonne
agg_tipol_new <- storico_final[, .(num_aziende = uniqueN(codazienda_cf)),
by = .(tipologia_allevamento, tipologia_produttiva)]
dettaglio_tipologia_produttiva_new <- ggplot(agg_tipol_new, aes(x = tipologia_produttiva, y = num_aziende, fill = tipologia_produttiva)) +
geom_col() +
geom_text(aes(label = num_aziende), vjust = -0.5) +
facet_grid(rows = vars(tipologia_allevamento), scales = "free_x") +  # facet verticale
labs(title = "Numero di aziende per tipologia produttiva",
x = "Tipologia produttiva",
y = "Numero di aziende (uniche)") +
theme_minimal() +
theme(axis.text.x = element_text(angle = 45, hjust = 1),
legend.position = "none")  # rimuove la legenda
dettaglio_tipologia_produttiva_new
fwrite(storico_final, file.path(output_dir, "storico_bovini_aperti2010_2025_Lombardia.csv"))
saveRDS(storico_final, file.path(output_dir, "storico_bovini_aperti2010_2025_Lombardia.rds"))
storico_Latte_Carne <- storico_final %>%
filter(tipologia_allevamento %in% c("Latte/Misto", "Produzione carne"))
#================Teniamo solo Latte/Misto e Carne===============================
storico_final <- readRDS(file.path(output_dir, "storico_bovini_aperti2010_2025_Lombardia.rds"))
storico_Latte_Carne <- storico_final %>%
filter(tipologia_allevamento %in% c("Latte/Misto", "Produzione carne"))
storico_Latte_Carne <- storico_final %>%
filter(tipologia_allevamento %in% c("Latte/Misto", "Produzione carne"))
names(storico_final)
levels(storico_final$tipologia_allevamento)
storico_Latte_Carne <- storico_final %>%
filter(tipologia_allevamento %in% c("Latte/Misto", "Produzione carne"))
storico_Latte_Carne <- storico_final[tipologia_allevamento %in% c("Latte/Misto", "Produzione carne")]
# 3. Analizza la distribuzione delle classi di consistenza
table(storico_filtrato$classe_consistenza)
# 3. Analizza la distribuzione delle classi di consistenza
table(storico_Latte_Carne$classe_consistenza)
saveRDS(storico_Latte_Carne, file.path(output_dir, "storico_bovini_aperti2010_2025_Lombardia_LatteMisto_Carne.rds"))
cat("Dataset salvato in:", file.path(output_dir, "storico_bovini_aperti2010_2025_Lombardia_LatteMisto_Carne.rds"), "\n")
#voglio controllare se ci sono allevamenti con classe di consistenza molto bassa per eventualmente toglierli
# Analizza la distribuzione delle classi di consistenza
table(storico_Latte_Carne$classe_consistenza)
ggplot(storico_Latte_Carne, aes(x = classe_consistenza, y = tot_capi)) +
geom_boxplot(fill = "steelblue", alpha = 0.7, outlier.color = "red") +
scale_y_continuous(labels = scales::comma) +
labs(title = "Variabilità del numero di capi per classe di consistenza",
x = "Classe di consistenza",
y = "Numero di capi") +
theme_minimal() +
theme(axis.text.x = element_text(angle = 45, hjust = 1))
#===================== STORICO DPLA ============================================
# converti a sf (WGS84 assumed); se coords in UTM -> trasformare opportunamente
storico_final <- readRDS(file.path(output_dir, "storico_bovini_aperti2010_2025_Lombardia.rds"))
coords_full <- storico_final[,.(codice_azienda, latitudine, longitudine)]
coords_full <- unique(coords_full)
allev_sf <- coords_full[!is.na(longitudine) & !is.na(latitudine)]
allev_sf <- st_as_sf(allev_sf, coords = c("longitudine","latitudine"), crs = 4326, remove = FALSE)
study_area     <- "M:/AH&W/SOA_15/Cassandra/Within farm/StudyArea/Comuni_riquadro_verde_4326.gpkg"
area <- st_read(study_area)  # assume già nel crs giusto o notare crs con st_crs(area)
# Assicurati che allev_sf e comuni abbiano lo stesso CRS
allev_sf <- st_transform(allev_sf, st_crs(area))
st_crs(area)
st_crs(allev_sf)
# se crs diversi, trasformare:
if (st_crs(area)$epsg != 4326) area <- st_transform(area, 4326)
plot(area$geom)
# intersection / spatial join
allev_sf_in_dpla <- st_intersection(allev_sf, area)
message("Allevamenti in area di studio: ", nrow(allev_sf_in_dpla))
plot(st_geometry(area), col = "lightblue", border = "black")
plot(st_geometry(allev_sf_in_dpla), col = "red", pch = 19, add = TRUE)
allev_sf_in_dpla <- as.data.table(allev_sf_in_dpla)
# Prepara dataset storico limitato agli allevamenti ZONA DPLA (per analisi temporale)----
# Unisci con dati_annuali per ricavare serie temporali solo per questi allevamenti
#se vogliamo considerare solo allevamenti nell'area di studio
allev_dpla <- st_drop_geometry(allev_sf_in_dpla)[, .(codice_azienda, longitudine, latitudine)]
setkeyv(storico_full, c("codice_azienda","longitudine", "latitudine"))
setkeyv(allev_dpla, c("codice_azienda","longitudine", "latitudine"))
storico_area_dpla <- storico_full[allev_dpla, nomatch = 0]  # contiene solo le righe per cui il match è perfetto per tutte e tre le chiavi
length(unique(storico_area_dpla$codice_azienda)) #deve essere uguale al numero di allev_dpla
length(unique(allev_dpla$codice_azienda))
levels(storico_final$modalita_allevamento)
tables(storico_final$modalita_allevamento)
table(storico_final$modalita_allevamento)
cols_to_factor <- c(
"orientamento_produttivo",
"tipologia_produttiva",
"classe_consistenza",
"flag_riproduzione",
"classe_allevamento",
"tipologia_allevamento",
"modalita_allevamento"
)
# Trasformazione in fattori
storico_area_dpla[, (cols_to_factor) := lapply(.SD, as.factor), .SDcols = cols_to_factor]
sapply(storico_area_dpla[, ..cols_to_factor], class)  # controlla le classi delle colonne
saveRDS(storico_area_dpla, "M:/AH&W/SOA_15/Cassandra/Within farm/Data/Bovini/tmp/output_bdn_bovini/storico_bovini_aperti2010_2025_DPLA.rds")
fwrite(storico_area_dpla, "M:/AH&W/SOA_15/Cassandra/Within farm/Data/Bovini/tmp/output_bdn_bovini/storico_bovini_aperti2010_2025_DPLA.csv")
##================Teniamo solo Latte/Misto e Carne===============================
storico_area_dpla <- readRDS(file.path(output_dir, "storico_bovini_aperti2010_2025_DPLA.rds"))
levels(storico_area_dpla$tipologia_allevamento)
storico_dpla_Latte_Carne <- storico_area_dpla[tipologia_allevamento %in% c("Latte/Misto", "Produzione carne")]
saveRDS(storico_dpla_Latte_Carne, file.path(output_dir, "storico_bovini_aperti2010_2025_DPLA_LatteMisto_Carne.rds"))
cat("Dataset salvato in:", file.path(output_dir, "storico_bovini_aperti2010_2025_DPLA_LatteMisto_Carne.rds"), "\n")
#voglio controllare se ci sono allevamenti con classe di consistenza molto bassa per eventualmente toglierli
# Analizza la distribuzione delle classi di consistenza
table(storico_dpla_Latte_Carne$classe_consistenza)
ggplot(storico_dpla_Latte_Carne, aes(x = classe_consistenza, y = tot_capi)) +
geom_boxplot(fill = "steelblue", alpha = 0.7, outlier.color = "red") +
scale_y_continuous(labels = scales::comma) +
labs(title = "Variabilità del numero di capi per classe di consistenza",
x = "Classe di consistenza",
y = "Numero di capi") +
theme_minimal() +
theme(axis.text.x = element_text(angle = 45, hjust = 1))
gc()
# Cartella principale
main_dir <- "M:/AH&W/SOA_15/Cassandra/Within farm"
output_dir <- "M:/AH&W/SOA_15/Cassandra/Within farm/Output/4_Trend_Analysis_Bovini_2010_2025"
# File input
input_file <- file.path(main_dir, "/Data/Bovini/tmp/output_bdn_bovini/storico_bovini_aperti2010_2025_Lombardia.rds")
# Caricamento
df <- readRDS(input_file) %>%
clean_names()
#Libreries----
library(tidyverse)
library(janitor)
library(lubridate)
library(Kendall)
library(trend)
library(segmented)
library(broom)
library(ggpubr)
# Caricamento dataset----
# Cartella principale
main_dir <- "M:/AH&W/SOA_15/Cassandra/Within farm"
output_dir <- "M:/AH&W/SOA_15/Cassandra/Within farm/Output/4_Trend_Analysis_Bovini_2010_2025"
# File input
input_file <- file.path(main_dir, "/Data/Bovini/tmp/output_bdn_bovini/storico_bovini_aperti2010_2025_Lombardia.rds")
# Caricamento
df <- readRDS(input_file) %>%
clean_names()
#Libreries----
library(tidyverse)
library(janitor)
library(lubridate)
library(Kendall)
library(trend)
library(segmented)
library(broom)
library(ggpubr)
# Caricamento dataset----
# Cartella principale
main_dir <- "M:/AH&W/SOA_15/Cassandra/Within farm"
output_dir <- "M:/AH&W/SOA_15/Cassandra/Within farm/Output/4_Trend_Analysis_Bovini_2010_2025"
# File input
input_file <- file.path(main_dir, "/Data/Bovini/tmp/output_bdn_bovini/storico_bovini_aperti2010_2025_Lombardia.rds")
# Caricamento
df <- readRDS(input_file) %>%
clean_names()
# ============================CHECK DEL DATASET=================================
# Anni presenti
years_present <- sort(unique(df$anno))
full_range <- 2010:2025
missing_years <- setdiff(full_range, years_present)
if (length(missing_years) > 0) {
warning(paste("ATTENZIONE: mancano gli anni:", paste(missing_years, collapse=", ")))
}
# Controllo colonne numeriche
numeric_cols <- df %>%
dplyr::select(starts_with("femmine"), starts_with("maschi"), starts_with("tot_bov"), tot_capi) %>%
names()
df <- df %>% mutate(across(all_of(numeric_cols), as.numeric))
# Ogni anno deve avere almeno una osservazione
obs_per_year <- df %>%
count(anno)
if (any(obs_per_year$n == 0)) {
warning("Ci sono anni senza osservazioni!")
}
# Ogni tipologia deve comparire in almeno 3 anni
tipology_years <- df %>%
group_by(tipologia_allevamento) %>%
summarise(n_anni = n_distinct(anno))
tipology_few_years <- tipology_years %>%
filter(n_anni < 3)
if (nrow(tipology_few_years) > 0) {
warning(paste("Tipologie con meno di 3 anni:", paste(tipology_few_years$tipologia_allevamento, collapse=", ")))
}
if (nrow(duplicates) > 0) {
warning(paste("Ci sono duplicati per allevamento/anno:", nrow(duplicates), "righe"))
}
duplicates <- df %>%
count(codazienda_cf, anno) %>%
filter(n > 1)
if (nrow(duplicates) > 0) {
warning(paste("Ci sono duplicati per allevamento/anno:", nrow(duplicates), "righe"))
}
levels(df$tipologia_allevamento)
df <- df %>%
filter(tipologia_allevamento %in% c("Latte/Misto", "Produzione carne"))%>%
droplevels
levels(df$tipologia_allevamento)
latte_carne <- readRDS("M:/AH&W/SOA_15/Cassandra/Within farm/Data/Bovini/tmp/output_bdn_bovini/storico_bovini_aperti2010_2025_Lombardia_LatteMisto_Carne.rds")
rm(latte_carne)
# Aggregazione per anno
agg_tot <- df %>%
group_by(anno) %>%
summarise(tot_capi_sum = sum(tot_capi, na.rm = TRUE), .groups = "drop")
View(agg_tot)
View(agg_tot)
# Grafico trend complessivo
ggplot(agg_tot, aes(x = anno, y = tot_capi_sum)) +
geom_line(color = "blue", size = 1.2) +
geom_point(size = 2) +
theme_bw() +
labs(title = "Trend complessivo del numero di capi - Lombardia",
x = "Anno", y = "Totale capi")
# Test regressione lineare
lm_model <- lm(tot_capi_sum ~ anno, data = agg_tot)
summary(lm_model)
# Test Mann-Kendall
mk_test <- MannKendall(agg_tot$tot_capi_sum)
mk_test
# Change point analysis
seg_model <- segmented(lm_model, seg.Z = ~ anno)
summary(seg_model)
mk_test
mk_test <- MannKendall(agg_tot$tot_capi_sum)
mk_test
summary(seg_model)
# Test regressione lineare
lm_model <- lm(tot_capi_sum ~ anno, data = agg_tot)
summary(lm_model)
# OUTPUT: p-value < 0.05 --> trend lineare significativo
# Test Mann-Kendall
mk_test <- MannKendall(agg_tot$tot_capi_sum)
mk_test
# OUTPUT: tau positivo --> trend crescente; p-value < 0.05 --> significativo
# Change point analysis
seg_model <- segmented(lm_model, seg.Z = ~ anno)
summary(seg_model)
agg_tipo <- df %>%
group_by(tipologia_allevamento, anno) %>%
summarise(tot_capi_sum = sum(tot_capi, na.rm = TRUE), .groups = "drop")
View(agg_tipo)
# Grafico trend per tipologia
ggplot(agg_tipo, aes(x = anno, y = tot_capi_sum, color = tipologia_allevamento)) +
geom_line(size = 1.2) +
geom_point(size = 2) +
theme_bw() +
labs(title = "Trend per tipologia di allevamento - Lombardia",
x = "Anno", y = "Totale capi")
# Test per ogni tipologia
tipos <- unique(agg_tipo$tipologia_allevamento)
results_tipo <- list()
for (t in tipos) {
df_t <- agg_tipo %>% filter(tipologia_allevamento == t)
lm_t <- lm(tot_capi_sum ~ anno, data = df_t)
mk_t <- MannKendall(df_t$tot_capi_sum)
seg_t <- tryCatch(segmented(lm_t, seg.Z = ~ anno), error = function(e) NULL)
bp <- if (!is.null(seg_t)) summary(seg_t)$psi[1, "Est."] else NA
results_tipo[[t]] <- tibble(
tipologia = t,
slope = coef(lm_t)[2],
p_value = summary(lm_t)$coefficients[2,4],
mann_kendall_tau = mk_t$tau,
mann_kendall_p = mk_t$sl,
breakpoint = bp
)
}
final_tipo <- bind_rows(results_tipo)
print(final_tipo)
View(final_tipo)
library(openxlsx)
library(dplyr)
library(DescTools)
library(clipr)
options(scipen = 999)
if(Sys.getenv("RSTUDIO")=="1")
setwd(dirname(rstudioapi:::getActiveDocumentContext()$path))
allev_3074_orig = read.xlsx("subarea3074PIVOT.xlsx", sheet = "subarea3074")
View(allev_3074_orig)
### MUNICIPALITIES
area_comuni_orig = read.xlsx("IT_COMUNI_2021.xlsx")
View(area_comuni_orig)
area_comuni = area_comuni_orig %>% select(COMUNE,Shape_Area) %>% distinct()
### MUNICIPALITIES
area_comuni_orig = read.xlsx("IT_COMUNI_2021.xlsx")
area_comuni = area_comuni_orig %>% select(COMUNE,Shape_Area) %>% distinct()
area_comuni$DS_COMUNE=toupper(area_comuni$COMUNE)
area_comuni = area_comuni_orig %>% dplyr::select(COMUNE,Shape_Area) %>% distinct()
area_comuni = area_comuni_orig %>% dplyr::select(COMUNE,Shape_Area) %>% distinct()
area_comuni$DS_COMUNE=toupper(area_comuni$COMUNE)
area_comuni$AREA=(area_comuni$Shape_Area)/1000000
area_comuni$DS_COMUNE[area_comuni$DS_COMUNE=="GABBIONETA-BINANUOVA"] = "GABBIONETA BINANUOVA"
area_comuni$DS_COMUNE[area_comuni$DS_COMUNE=="GADESCO-PIEVE DELMONA"] = "GADESCO PIEVE DELMONA"
View(area_comuni)
View(allev_3074_orig)
allev_3074 = allev_3074_orig %>% left_join(area_comuni, by="DS_COMUNE")
comuni_greenbox = allev_3074 %>% select(PROVINCIA,DS_COMUNE,AREA) %>% distinct()
comuni_greenbox = allev_3074 %>% dplyr::select(PROVINCIA,DS_COMUNE,AREA) %>% distinct()
View(comuni_greenbox)
()
allev_capi_prov = allev_3074 %>% group_by(PROVINCIA) %>% summarise(n_allev = n(),
somma_capi = sum(capi)) %>% distinct()
allev_capi_prov
View(allev_capi_prov)
allev_capi_tot = allev_3074 %>% summarise(n_allev = n(),
somma_capi = sum(capi)) %>% distinct()
View(allev_capi_tot)
allev_capi_tot
dens_tot = capi_tot/area
area = 3020.7
dens_tot = capi_tot/area
dens_tot = allev_capi_tot$somma_capi/area
dens_tot
### Acquafredda + Calvisano + Gottolengo
allev_3074_3comuni = allev_3074 %>% filter(COMUNE=="Acquafredda" | COMUNE=="Calvisano" | COMUNE=="Gottolengo")
desc2 = allev_3074_3comuni %>% group_by(COMUNE) %>% summarise(n_allev=n())
desc2
desc3 = allev_3074_3comuni %>% filter(capi>10) %>% group_by(COMUNE) %>% summarise(n_allev=n(),
somma_capi=sum(capi))
desc3
desc4 = allev_3074_3comuni %>% dplyr::select(COMUNE,AREA) %>% distinct()
desc4
desc5 = allev_3074_3comuni %>% filter(capi>10) %>% group_by(COMUNE) %>% summarise(allev_densita=n()/AREA,
capi_densita=sum(capi)/AREA) %>% distinct()
desc5
##############################################################
###################### FMD ANALYSIS ##########################
##############################################################
library(openxlsx)
library(dplyr)
library(DescTools)
library(clipr)
options(scipen = 999)
if(Sys.getenv("RSTUDIO")=="1")
setwd(dirname(rstudioapi:::getActiveDocumentContext()$path))
### GLOSSARY
# allev = farms
# capi = heads
# somma_capi = sum of heads
# comuni = municipalities
# provincia / prov = province
# allev_densita = farm density
# capi_densita = head density
###INPUT FILE DESCRIPTION
# subarea3074PIVOT.xlsx, sheet ="subarea3074" = dataset defining for each farm the municipality, production type, farmed species, head number, and coordinates.
# IT_COMUNI_2021.xlsx = dataset of Italian municipalities, reporting also area and coordinates.
####### STUDY AREA
### FARMS IN DPLA
allev_3074_orig = read.xlsx("subarea3074PIVOT.xlsx", sheet = "subarea3074")
area_comuni = area_comuni_orig %>% dplyr::select(COMUNE,Shape_Area) %>% distinct()
area_comuni$DS_COMUNE=toupper(area_comuni$COMUNE)
area_comuni$AREA=(area_comuni$Shape_Area)/1000000 #convert area in km2
area_comuni$DS_COMUNE[area_comuni$DS_COMUNE=="GABBIONETA-BINANUOVA"] = "GABBIONETA BINANUOVA"
area_comuni$DS_COMUNE[area_comuni$DS_COMUNE=="GADESCO-PIEVE DELMONA"] = "GADESCO PIEVE DELMONA"
allev_3074 = allev_3074_orig %>% left_join(area_comuni, by="DS_COMUNE")
comuni_greenbox = allev_3074 %>% dplyr::select(PROVINCIA,DS_COMUNE,AREA) %>% distinct() #select only the municipalities of farms of interest
#calculate number of farms and herds by province
allev_capi_prov = allev_3074 %>% group_by(PROVINCIA) %>% summarise(n_allev = n(),
somma_capi = sum(capi)) %>% distinct()
allev_capi_prov
#calculate number of farms and herds in the whole study area (DPLA area)
allev_capi_tot = allev_3074 %>% summarise(n_allev = n(),
somma_capi = sum(capi)) %>% distinct()
allev_capi_tot
#Define total study area
area = 3020.7
dens_tot = allev_capi_tot$somma_capi/area
dens_tot
### Acquafredda + Calvisano + Gottolengo: municipalities with highest animal density, and more involved in baseline simulations of FMD spread
allev_3074_3comuni = allev_3074 %>% filter(COMUNE=="Acquafredda" | COMUNE=="Calvisano" | COMUNE=="Gottolengo")
#Calculate number of farms for each filtered municipality
desc2 = allev_3074_3comuni %>% group_by(COMUNE) %>% summarise(n_allev=n())
desc2
#Calculate number of herds for each filtered municipality, after filtering only for farms with more than 10 animals
desc3 = allev_3074_3comuni %>% filter(capi>10) %>% group_by(COMUNE) %>% summarise(n_allev=n(),
somma_capi=sum(capi))
desc3
#extract area for each municipality of interest
desc4 = allev_3074_3comuni %>% dplyr::select(COMUNE,AREA) %>% distinct()
desc4
#calculate animal density for each municipality of interest
desc5 = allev_3074_3comuni %>% filter(capi>10) %>% group_by(COMUNE) %>% summarise(allev_densita=n()/AREA,
capi_densita=sum(capi)/AREA) %>% distinct()
desc5
